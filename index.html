<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Query Runner — Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container dashboard">

    <header class="topbar">
        <h2>Query Runner Tool</h2>
    </header>

    <div class="content">
        <aside class="sidebar">
            {% if error %}
                <div class="error">{{ error }}</div>
            {% endif %}

            <form method="POST" id="mainForm">
                <div class="form-group">
                    <label>Select Database:</label>
                    <select name="db" required>
                        <option value="postgres" selected>PostgreSQL</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Org Codes (optional):</label>
                    <select name="org_codes" multiple size="10" class="org-select" id="orgSelect">
                        {% for code, cname in org_map.items() %}
                            <option value="{{ code }}" {% if code in selected_orgs %}selected{% endif %}>{{ code }} — {{ cname }}</option>
                        {% endfor %}
                    </select>
                    <small class="muted">Hold Ctrl/Cmd to select multiple.</small>
                </div>

                

                <div class="form-group">
                    <label>Save Query (name):</label>
                    <input type="text" name="save_name" placeholder="Enter a name to save (optional)">
                </div>

                {% if saved %}
                <div class="form-group">
                    <label>Load Saved Query:</label>
                    <select name="load_saved">
                        <option value="">-- Select saved query --</option>
                        {% for s in saved %}
                            <option value="{{ s.name }}">{{ s.name }} — {{ s.created_at }}</option>
                        {% endfor %}
                    </select>
                    <small class="muted">Choose a saved query to prefill form.</small>
                </div>
                {% endif %}

                <div class="button-area" style="margin-top:12px;">
                    <button type="submit" title="Run / Save / Load (single form)">Run Query</button>
                </div>
            </form>
        </aside>

        <main class="mainpanel">
            <section class="editor">
                <label>Write SQL Query:</label>
                <textarea form="mainForm" name="query" required placeholder="Write SQL here... (use {org} if needed)">{{ query }}</textarea>
                <small class="muted">Use <code>{org}</code> where you want the org_code.</small>
                <div style="margin-top:10px;">
                    <button form="mainForm" type="submit">Run</button>
                </div>
            </section>

            <section class="results">
                {% if results %}
                    {% for org, data in results.items() %}
                        <div class="result-container">
                            <div class="result-head">
                                <h3>{{ org }} — {{ data.client_name }}</h3>
                                <div class="result-actions">
                                    <form method="POST" action="{{ url_for('download_csv') }}" style="display:inline;">
                                        <input type="hidden" name="query" value="{{ data.query_used }}">
                                        <button type="submit">Download CSV</button>
                                    </form>
                                </div>
                            </div>

                            <div class="used-query"><strong>Query used:</strong>
                                <code>{{ data.query_used }}</code>
                            </div>

                            <div class="table-area">
                                {% if data.output is string %}
                                    <div class="error">{{ data.output }}</div>
                                {% elif data.output.rows %}
                                    <table>
                                        <thead>
                                            <tr>
                                                {% for col in data.output.columns %}
                                                    <th>{{ col }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in data.output.rows %}
                                                <tr>
                                                    {% for cell in row %}
                                                        <td>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <div class="muted">No rows returned for {{ org }}.</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="muted">Run a query to see results here.</div>
                {% endif %}
            </section>
        </main>
    </div>
</div>


</body>
</html>
